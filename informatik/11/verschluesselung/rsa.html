<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSA Labor & Zertifizierungsstelle</title>
    <link rel="stylesheet" href="https://edu-mrh.de/embed/style.css">
    <link rel="icon" type="image/png" href="https://edu-mrh.de/embed/icons/favicon.png">
    <style>
        /* Zus√§tzliche spezifische Styles f√ºr die RSA-Anwendung */
        .rsa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .rsa-card {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .rsa-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .rsa-card h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .result-box {
            background: var(--gray-lighter);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
            border-left: 4px solid var(--success-color);
        }

        .result-box h5 {
            color: var(--success-color);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .result-box p {
            color: var(--dark);
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .error-box {
            background: #fee2e2;
            border: 2px solid var(--danger-color);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            color: var(--danger-color);
        }

        .success-box {
            background: #d1fae5;
            border: 2px solid var(--success-color);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            color: var(--success-color);
        }

        .contact-list {
            list-style: none;
            padding: 0;
        }

        .contact-item {
            background: var(--gray-lighter);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-item:last-child {
            margin-bottom: 0;
        }

        .contact-info {
            flex: 1;
        }

        .contact-info strong {
            display: block;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .contact-info small {
            color: var(--gray);
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .math-display {
            background: var(--white);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
            border: 2px solid var(--primary-light);
        }

        .step-indicator {
            display: inline-block;
            background: var(--primary-color);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .info-text {
            color: var(--gray);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .highlight-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }

        .highlight-box h5 {
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .highlight-box p {
            margin: 0;
            opacity: 0.95;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .button-group .btn {
            flex: 1;
            min-width: 150px;
        }

        @media (max-width: 768px) {
            .rsa-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .button-group .btn {
                width: 100%;
            }

            .contact-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <span class="icon"><a href="https://edu-mrh.de/">üîê</a></span>
                <span>RSA Labor</span>
            </div>
            <div class="nav-progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="nav-links">
               <div class="nav-links">
                <a href="https://edu-mrh.de/informatik/informatik.html#jahrgang-12" class="btn btn-outline">√úbersicht</a>
                <a href="https://edu-mrh.de/contribute.html#impressum" class="btn btn-outline">Impressum</a>
            </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navigation</h3>
            <button class="sidebar-toggle" id="sidebarToggle">‚úï</button>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="nav-link active" data-section="home">üè† Startseite</a></li>
            <li><a href="#" class="nav-link" data-section="step1">üìê Schritt 1: Mathematik</a></li>
            <li><a href="#" class="nav-link" data-section="step2">üë§ Schritt 2: Identit√§t</a></li>
            <li><a href="#" class="nav-link" data-section="step3">üèõÔ∏è Schritt 3: CA-Amt</a></li>
            <li><a href="#" class="nav-link" data-section="step4">üì§ Schritt 4: Senden</a></li>
            <li><a href="#" class="nav-link" data-section="step5">üì• Schritt 5: Empfangen</a></li>
        </ul>
    </aside>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Home Section -->
            <section id="home" class="content-section active">
                <div class="hero">
                    <h1 class="hero-title">RSA Labor & Zertifizierungsstelle</h1>
                    <p class="hero-subtitle">Verstehe Public-Key-Kryptographie durch praktische Anwendung</p>
                    <p class="hero-description">Lerne die Grundlagen von RSA-Verschl√ºsselung, digitalen Signaturen und Zertifikaten</p>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-icon">üìê</div>
                        <h3>Schritt 1: Mathematik</h3>
                        <p class="info-text">Berechne RSA-Parameter mit kleinen Primzahlen und verstehe die mathematischen Grundlagen.</p>
                        <ul>
                            <li>Berechnung von N und Œ¶(N)</li>
                            <li>Wahl des √∂ffentlichen Exponenten e</li>
                            <li>Berechnung des geheimen Exponenten d</li>
                            <li>Ver- und Entschl√ºsselung testen</li>
                        </ul>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">üë§</div>
                        <h3>Schritt 2: Identit√§t</h3>
                        <p class="info-text">Erstelle deine eigene digitale Identit√§t mit RSA-Schl√ºsselpaar.</p>
                        <ul>
                            <li>Generiere sichere Schl√ºssel</li>
                            <li>Verwalte Kontakte</li>
                            <li>Verifiziere Zertifikate</li>
                        </ul>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">üèõÔ∏è</div>
                        <h3>Schritt 3: CA-Amt</h3>
                        <p class="info-text">Agiere als Zertifizierungsstelle und stelle vertrauensw√ºrdige Zertifikate aus.</p>
                        <ul>
                            <li>CA-Schl√ºssel generieren</li>
                            <li>Identit√§ten pr√ºfen</li>
                            <li>Zertifikate signieren</li>
                        </ul>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">üì§</div>
                        <h3>Schritt 4: Senden</h3>
                        <p class="info-text">Verschl√ºssele und signiere Nachrichten sicher.</p>
                        <ul>
                            <li>Nachricht verschl√ºsseln</li>
                            <li>Digital signieren</li>
                            <li>Sicher √ºbermitteln</li>
                        </ul>
                    </div>

                    <div class="info-card">
                        <div class="info-icon">üì•</div>
                        <h3>Schritt 5: Empfangen</h3>
                        <p class="info-text">Entschl√ºssele Nachrichten und verifiziere Signaturen.</p>
                        <ul>
                            <li>Nachricht entschl√ºsseln</li>
                            <li>Signatur pr√ºfen</li>
                            <li>Absender verifizieren</li>
                        </ul>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-primary" onclick="navigateToSection('step1')">
                        Los geht's! ‚Üí
                    </button>
                </div>
            </section>

            <!-- Step 1: Mathematik -->
            <section id="step1" class="content-section">
                <div class="chapter-header">
                    <span class="chapter-number">Schritt 1</span>
                    <h2>Das mathematische Fundament</h2>
                </div>

                <div class="example-box">
                    <h3>üìê RSA-Parameter berechnen</h3>
                    <div class="example-content">
                        <p class="info-text">Berechne die RSA-Parameter f√ºr kleine Primzahlen (p=5, q=17):</p>
                        
                        <div class="highlight-box">
                            <h5>Gegeben:</h5>
                            <p>p = 5, q = 17</p>
                        </div>
                    </div>
                </div>

                <div class="rsa-grid">
                    <div class="rsa-card">
                        <h4>1Ô∏è‚É£ N und Œ¶(N) berechnen</h4>
                        <div class="form-group">
                            <label>N = p √ó q</label>
                            <input type="number" id="calcN" readonly>
                        </div>
                        <div class="form-group">
                            <label>Œ¶(N) = (p-1) √ó (q-1)</label>
                            <input type="number" id="calcPhi" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="calculateNAndPhi()">Berechnen</button>
                    </div>

                    <div class="rsa-card">
                        <h4>2Ô∏è‚É£ √ñffentlicher Exponent e</h4>
                        <p class="info-text">W√§hle ein e, das zu Œ¶(N) und N teilerfremd ist:</p>
                        <div class="form-group">
                            <label>M√∂gliche Werte f√ºr e:</label>
                            <select id="selectE" onchange="updateE()">
                                <option value="">-- W√§hlen --</option>
                            </select>
                        </div>
                        <div id="eResult"></div>
                    </div>

                    <div class="rsa-card">
                        <h4>3Ô∏è‚É£ Geheimer Exponent d</h4>
                        <p class="info-text">Berechne d so dass: (e ¬∑ d) mod Œ¶(N) = 1</p>
                        <div class="form-group">
                            <label>d =</label>
                            <input type="number" id="calcD" readonly>
                        </div>
                        <button class="btn btn-primary" onclick="calculateD()">Berechnen</button>
                        <div id="dResult"></div>
                    </div>
                </div>

                <div class="example-box">
                    <h3>üß™ ASCII-Test (Mathematisch)</h3>
                    <div class="example-content">
                        <div class="rsa-grid">
                            <div class="rsa-card">
                                <h4>Verschl√ºsseln</h4>
                                <div class="form-group">
                                    <label>ASCII-Wert m =</label>
                                    <input type="number" id="asciiM" value="72">
                                </div>
                                <p class="info-text">Berechne: c = m<sup>e</sup> mod N</p>
                                <button class="btn btn-success" onclick="encryptASCII()">Verschl√ºsseln</button>
                                <div id="encryptResult"></div>
                            </div>

                            <div class="rsa-card">
                                <h4>Entschl√ºsseln</h4>
                                <div class="form-group">
                                    <label>Chiffrat c =</label>
                                    <input type="number" id="asciiC" readonly>
                                </div>
                                <p class="info-text">Berechne: m = c<sup>d</sup> mod N</p>
                                <button class="btn btn-success" onclick="decryptASCII()">Entschl√ºsseln</button>
                                <div id="decryptResult"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-outline" onclick="navigateToSection('home')">‚Üê Zur√ºck</button>
                    <button class="btn btn-primary" onclick="navigateToSection('step2')">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Step 2: Identit√§t -->
            <section id="step2" class="content-section">
                <div class="chapter-header">
                    <span class="chapter-number">Schritt 2</span>
                    <h2>Identit√§t & Kontakte</h2>
                </div>

                <div class="rsa-grid">
                    <div class="rsa-card">
                        <h4>üë§ Meine Schl√ºssel</h4>
                        <div class="form-group">
                            <label>Dein Name:</label>
                            <input type="text" id="userName" placeholder="z.B. Alice">
                        </div>
                        <button class="btn btn-primary" onclick="generateKeys()">Schl√ºssel generieren</button>
                        <div id="keyResult"></div>
                    </div>

                    <div class="rsa-card">
                        <h4>üìã Kontakt verifizieren (Zertifikat)</h4>
                        <p class="info-text">F√ºge hier ein Zertifikat ein, um einen Kontakt sicher zu speichern.</p>
                        <div class="form-group">
                            <label>Zertifikat (JSON):</label>
                            <textarea id="certInput" placeholder='{"name":"Bob","publicKey":"...","signature":"..."}'></textarea>
                        </div>
                        <button class="btn btn-success" onclick="verifyCertificate()">Verifizieren & Speichern</button>
                        <div id="certResult"></div>
                    </div>
                </div>

                <div class="example-box">
                    <h3>üìá Gespeicherte Kontakte</h3>
                    <div class="example-content">
                        <ul class="contact-list" id="contactList">
                            <li class="contact-item">
                                <div class="contact-info">
                                    <small>Noch keine Kontakte gespeichert</small>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-outline" onclick="navigateToSection('step1')">‚Üê Zur√ºck</button>
                    <button class="btn btn-primary" onclick="navigateToSection('step3')">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Step 3: CA -->
            <section id="step3" class="content-section">
                <div class="chapter-header">
                    <span class="chapter-number">Schritt 3</span>
                    <h2>Zertifizierungsstelle (CA-Amt)</h2>
                </div>

                <div class="example-box warning">
                    <h3>üèõÔ∏è Vertrauens-Check</h3>
                    <div class="example-content">
                        <p class="info-text">
                            Eine Zertifizierungsstelle (CA) ist eine vertrauensw√ºrdige dritte Partei, 
                            die die Identit√§t von Personen best√§tigt und digitale Zertifikate ausstellt.
                        </p>
                        <div class="highlight-box">
                            <h5>Wichtig:</h5>
                            <p>Alle Teilnehmer m√ºssen dem √∂ffentlichen Schl√ºssel der CA vertrauen!</p>
                        </div>
                    </div>
                </div>

                <div class="rsa-grid">
                    <div class="rsa-card">
                        <h4>üîë CA Master-Setup</h4>
                        <p class="info-text">Als Zentrale: Erzeuge den CA-Key, dem alle vertrauen m√ºssen.</p>
                        <button class="btn btn-primary" onclick="generateCAKeys()">CA-Schl√ºssel generieren</button>
                        <div id="caKeyResult"></div>
                        <div class="highlight mt-2">
                            <p><strong>Hinweis:</strong> Diesen Key m√ºssen alle Korrespondenten kennen, um Zertifikate zu pr√ºfen.</p>
                        </div>
                    </div>

                    <div class="rsa-card">
                        <h4>üìú Zertifikat ausstellen</h4>
                        <div class="form-group">
                            <label>Name der Person:</label>
                            <input type="text" id="certName" placeholder="z.B. Bob">
                        </div>
                        <div class="form-group">
                            <label>Public Key der Person:</label>
                            <textarea id="certPublicKey" placeholder="Public Key einf√ºgen"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="issueCertificate()">Zertifikat ausstellen</button>
                        <div id="issuedCertResult"></div>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-outline" onclick="navigateToSection('step2')">‚Üê Zur√ºck</button>
                    <button class="btn btn-primary" onclick="navigateToSection('step4')">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Step 4: Senden -->
            <section id="step4" class="content-section">
                <div class="chapter-header">
                    <span class="chapter-number">Schritt 4</span>
                    <h2>Nachricht senden</h2>
                </div>

                <div class="example-box">
                    <h3>üì§ Sichere Nachricht erstellen</h3>
                    <div class="example-content">
                        <p class="info-text">
                            Verschl√ºssele deine Nachricht mit dem √∂ffentlichen Schl√ºssel des Empf√§ngers 
                            und signiere sie mit deinem privaten Schl√ºssel.
                        </p>
                    </div>
                </div>

                <div class="rsa-card">
                    <div class="form-group">
                        <label>Empf√§nger ausw√§hlen:</label>
                        <select id="recipientSelect">
                            <option value="">-- W√§hle einen Kontakt --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Deine Nachricht:</label>
                        <textarea id="messageToSend" placeholder="Schreibe deine Nachricht hier..."></textarea>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="encryptMessage()">üîí Verschl√ºsseln</button>
                        <button class="btn btn-secondary" onclick="signMessage()">‚úçÔ∏è Signieren</button>
                        <button class="btn btn-success" onclick="encryptAndSign()">üîê Verschl√ºsseln & Signieren</button>
                    </div>

                    <div id="sendResult"></div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-outline" onclick="navigateToSection('step3')">‚Üê Zur√ºck</button>
                    <button class="btn btn-primary" onclick="navigateToSection('step5')">Weiter ‚Üí</button>
                </div>
            </section>

            <!-- Step 5: Empfangen -->
            <section id="step5" class="content-section">
                <div class="chapter-header">
                    <span class="chapter-number">Schritt 5</span>
                    <h2>Empfangen</h2>
                </div>

                <div class="example-box">
                    <h3>üì• Nachricht empfangen und pr√ºfen</h3>
                    <div class="example-content">
                        <p class="info-text">
                            Entschl√ºssele die Nachricht mit deinem privaten Schl√ºssel und 
                            verifiziere die Signatur mit dem √∂ffentlichen Schl√ºssel des Absenders.
                        </p>
                    </div>
                </div>

                <div class="rsa-card">
                    <div class="form-group">
                        <label>Empfangene Nachricht (JSON):</label>
                        <textarea id="receivedMessage" placeholder='{"encrypted":"...","signature":"...","sender":"..."}'></textarea>
                    </div>

                    <div class="button-group">
                        <button class="btn btn-primary" onclick="decryptMessage()">üîì Entschl√ºsseln</button>
                        <button class="btn btn-success" onclick="verifySignature()">‚úÖ Signatur pr√ºfen</button>
                        <button class="btn btn-secondary" onclick="decryptAndVerify()">üîç Entschl√ºsseln & Verifizieren</button>
                    </div>

                    <div id="receiveResult"></div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn btn-outline" onclick="navigateToSection('step4')">‚Üê Zur√ºck</button>
                    <button class="btn btn-success" onclick="navigateToSection('home')">üè† Zum Start</button>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2026 RSA Labor. Bildungsprojekt f√ºr Kryptographie.</p>
            <p>Entwickelt f√ºr das Verst√§ndnis von Public-Key-Infrastruktur</p>
        </div>
    </footer>

    <script>
        // ==================== Global Variables ====================
        let myKeys = null;
        let caKeys = null;
        let contacts = [];
        let rsaParams = {
            p: 5,
            q: 17,
            N: null,
            phi: null,
            e: null,
            d: null
        };

        // ==================== Navigation ====================
        function navigateToSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show target section
            document.getElementById(sectionId).classList.add('active');

            // Update sidebar active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionId) {
                    link.classList.add('active');
                }
            });

            // Update progress bar
            const sections = ['home', 'step1', 'step2', 'step3', 'step4', 'step5'];
            const currentIndex = sections.indexOf(sectionId);
            const progress = (currentIndex / (sections.length - 1)) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Close mobile menu
            document.getElementById('sidebar').classList.remove('active');
        }

        // Sidebar navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                navigateToSection(section);
            });
        });

        // Mobile menu toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });

        document.getElementById('sidebarToggle').addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('active');
        });

        // ==================== Helper Functions ====================
        function gcd(a, b) {
            while (b !== 0) {
                let temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }

        function modInverse(e, phi) {
            let m0 = phi, t, q;
            let x0 = 0, x1 = 1;

            if (phi === 1) return 0;

            while (e > 1) {
                q = Math.floor(e / phi);
                t = phi;
                phi = e % phi;
                e = t;
                t = x0;
                x0 = x1 - q * x0;
                x1 = t;
            }

            if (x1 < 0) x1 += m0;

            return x1;
        }

        function modPow(base, exp, mod) {
            let result = 1;
            base = base % mod;
            while (exp > 0) {
                if (exp % 2 === 1) {
                    result = (result * base) % mod;
                }
                exp = Math.floor(exp / 2);
                base = (base * base) % mod;
            }
            return result;
        }

        function isPrime(num) {
            if (num <= 1) return false;
            if (num <= 3) return true;
            if (num % 2 === 0 || num % 3 === 0) return false;
            for (let i = 5; i * i <= num; i += 6) {
                if (num % i === 0 || num % (i + 2) === 0) return false;
            }
            return true;
        }

        function generatePrime(min, max) {
            let prime;
            do {
                prime = Math.floor(Math.random() * (max - min + 1)) + min;
            } while (!isPrime(prime));
            return prime;
        }

        function stringToNumbers(str) {
            return Array.from(str).map(char => char.charCodeAt(0));
        }

        function numbersToString(nums) {
            return nums.map(num => String.fromCharCode(num)).join('');
        }

        function sha256Simple(str) {
            // Simple hash for demonstration (not cryptographically secure)
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash);
        }

        // ==================== Step 1: Mathematics ====================
        function calculateNAndPhi() {
            rsaParams.N = rsaParams.p * rsaParams.q;
            rsaParams.phi = (rsaParams.p - 1) * (rsaParams.q - 1);

            document.getElementById('calcN').value = rsaParams.N;
            document.getElementById('calcPhi').value = rsaParams.phi;

            // Populate e options
            const selectE = document.getElementById('selectE');
            selectE.innerHTML = '<option value="">-- W√§hlen --</option>';

            for (let e = 2; e < rsaParams.phi; e++) {
                if (gcd(e, rsaParams.phi) === 1 && gcd(e, rsaParams.N) === 1) {
                    const option = document.createElement('option');
                    option.value = e;
                    option.textContent = e;
                    selectE.appendChild(option);
                }
            }
        }

        function updateE() {
            const e = parseInt(document.getElementById('selectE').value);
            if (e) {
                rsaParams.e = e;
                const resultDiv = document.getElementById('eResult');
                resultDiv.innerHTML = `
                    <div class="result-box">
                        <h5>‚úÖ Gew√§hlt:</h5>
                        <p>e = ${e}</p>
                        <p>gcd(e, Œ¶(N)) = ${gcd(e, rsaParams.phi)}</p>
                    </div>
                `;
            }
        }

        function calculateD() {
            if (!rsaParams.e || !rsaParams.phi) {
                alert('Bitte zuerst e w√§hlen!');
                return;
            }

            rsaParams.d = modInverse(rsaParams.e, rsaParams.phi);
            document.getElementById('calcD').value = rsaParams.d;

            const resultDiv = document.getElementById('dResult');
            resultDiv.innerHTML = `
                <div class="result-box">
                    <h5>‚úÖ Berechnet:</h5>
                    <p>d = ${rsaParams.d}</p>
                    <p>Verifikation: (e √ó d) mod Œ¶(N) = ${(rsaParams.e * rsaParams.d) % rsaParams.phi}</p>
                </div>
            `;
        }

        function encryptASCII() {
            if (!rsaParams.e || !rsaParams.N) {
                alert('Bitte zuerst alle Parameter berechnen!');
                return;
            }

            const m = parseInt(document.getElementById('asciiM').value);
            const c = modPow(m, rsaParams.e, rsaParams.N);

            document.getElementById('asciiC').value = c;

            const resultDiv = document.getElementById('encryptResult');
            resultDiv.innerHTML = `
                <div class="result-box">
                    <h5>üîí Verschl√ºsselt:</h5>
                    <p>m = ${m} (ASCII: '${String.fromCharCode(m)}')</p>
                    <p>c = ${m}<sup>${rsaParams.e}</sup> mod ${rsaParams.N} = ${c}</p>
                </div>
            `;
        }

        function decryptASCII() {
            if (!rsaParams.d || !rsaParams.N) {
                alert('Bitte zuerst d berechnen!');
                return;
            }

            const c = parseInt(document.getElementById('asciiC').value);
            if (!c) {
                alert('Bitte zuerst verschl√ºsseln!');
                return;
            }

            const m = modPow(c, rsaParams.d, rsaParams.N);

            const resultDiv = document.getElementById('decryptResult');
            resultDiv.innerHTML = `
                <div class="result-box">
                    <h5>üîì Entschl√ºsselt:</h5>
                    <p>c = ${c}</p>
                    <p>m = ${c}<sup>${rsaParams.d}</sup> mod ${rsaParams.N} = ${m}</p>
                    <p>ASCII-Zeichen: '${String.fromCharCode(m)}'</p>
                </div>
            `;
        }

        // ==================== Step 2: Identity ====================
        function generateKeys() {
            const name = document.getElementById('userName').value.trim();
            if (!name) {
                alert('Bitte gib deinen Namen ein!');
                return;
            }

            // Generate RSA keys (using larger primes for security)
            const p = generatePrime(100, 500);
            const q = generatePrime(100, 500);
            const n = p * q;
            const phi = (p - 1) * (q - 1);

            // Choose e
            let e = 65537;
            if (e >= phi || gcd(e, phi) !== 1) {
                e = 3;
                while (gcd(e, phi) !== 1) {
                    e += 2;
                }
            }

            // Calculate d
            const d = modInverse(e, phi);

            myKeys = {
                name: name,
                publicKey: { e: e, n: n },
                privateKey: { d: d, n: n }
            };

            const resultDiv = document.getElementById('keyResult');
            resultDiv.innerHTML = `
                <div class="result-box">
                    <h5>‚úÖ Schl√ºssel generiert f√ºr: ${name}</h5>
                    <p><strong>Public Key:</strong></p>
                    <p>e = ${e}, n = ${n}</p>
                    <p><strong>Private Key:</strong></p>
                    <p>d = ${d}, n = ${n}</p>
                </div>
                <div class="highlight mt-2">
                    <p><strong>Wichtig:</strong> Teile nur deinen Public Key mit anderen!</p>
                </div>
            `;

            updateRecipientSelect();
        }

        function verifyCertificate() {
            const certInput = document.getElementById('certInput').value.trim();
            if (!certInput) {
                alert('Bitte Zertifikat einf√ºgen!');
                return;
            }

            try {
                const cert = JSON.parse(certInput);

                if (!cert.name || !cert.publicKey || !cert.signature) {
                    throw new Error('Ung√ºltiges Zertifikat-Format');
                }

                if (!caKeys) {
                    alert('Kein CA Public Key verf√ºgbar! Bitte zuerst CA-Schl√ºssel generieren.');
                    return;
                }

                // Verify signature
                const data = JSON.stringify({ name: cert.name, publicKey: cert.publicKey });
                const hash = sha256Simple(data);
                const decryptedHash = modPow(cert.signature, caKeys.publicKey.e, caKeys.publicKey.n);

                if (hash === decryptedHash) {
                    // Add to contacts
                    contacts.push({
                        name: cert.name,
                        publicKey: cert.publicKey
                    });

                    updateContactList();
                    updateRecipientSelect();

                    document.getElementById('certResult').innerHTML = `
                        <div class="success-box">
                            <strong>‚úÖ Zertifikat verifiziert!</strong>
                            <p>${cert.name} wurde zu deinen Kontakten hinzugef√ºgt.</p>
                        </div>
                    `;
                    document.getElementById('certInput').value = '';
                } else {
                    throw new Error('Signatur ung√ºltig!');
                }
            } catch (error) {
                document.getElementById('certResult').innerHTML = `
                    <div class="error-box">
                        <strong>‚ùå Fehler:</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function updateContactList() {
            const listElement = document.getElementById('contactList');

            if (contacts.length === 0) {
                listElement.innerHTML = `
                    <li class="contact-item">
                        <div class="contact-info">
                            <small>Noch keine Kontakte gespeichert</small>
                        </div>
                    </li>
                `;
                return;
            }

            listElement.innerHTML = contacts.map((contact, index) => `
                <li class="contact-item">
                    <div class="contact-info">
                        <strong>${contact.name}</strong>
                        <small>e: ${contact.publicKey.e}, n: ${contact.publicKey.n}</small>
                    </div>
                    <button class="btn btn-small btn-outline" onclick="removeContact(${index})">Entfernen</button>
                </li>
            `).join('');
        }

        function removeContact(index) {
            contacts.splice(index, 1);
            updateContactList();
            updateRecipientSelect();
        }

        function updateRecipientSelect() {
            const select = document.getElementById('recipientSelect');
            select.innerHTML = '<option value="">-- W√§hle einen Kontakt --</option>';

            contacts.forEach((contact, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = contact.name;
                select.appendChild(option);
            });
        }

        // ==================== Step 3: CA ====================
        function generateCAKeys() {
            const p = generatePrime(100, 500);
            const q = generatePrime(100, 500);
            const n = p * q;
            const phi = (p - 1) * (q - 1);

            let e = 65537;
            if (e >= phi || gcd(e, phi) !== 1) {
                e = 3;
                while (gcd(e, phi) !== 1) {
                    e += 2;
                }
            }

            const d = modInverse(e, phi);

            caKeys = {
                publicKey: { e: e, n: n },
                privateKey: { d: d, n: n }
            };

            document.getElementById('caKeyResult').innerHTML = `
                <div class="result-box">
                    <h5>‚úÖ CA-Schl√ºssel generiert</h5>
                    <p><strong>CA Public Key:</strong></p>
                    <p>e = ${e}, n = ${n}</p>
                    <p><strong>CA Private Key:</strong></p>
                    <p>d = ${d}, n = ${n}</p>
                </div>
                <div class="highlight-box mt-2">
                    <h5>‚ö†Ô∏è Wichtig:</h5>
                    <p>Den CA Public Key m√ºssen alle Korrespondenten kennen, um Zertifikate zu pr√ºfen.</p>
                    <p>Den CA Private Key geheim halten!</p>
                </div>
            `;
        }

        function issueCertificate() {
            const name = document.getElementById('certName').value.trim();
            const publicKeyStr = document.getElementById('certPublicKey').value.trim();

            if (!name || !publicKeyStr) {
                alert('Bitte alle Felder ausf√ºllen!');
                return;
            }

            if (!caKeys) {
                alert('Bitte zuerst CA-Schl√ºssel generieren!');
                return;
            }

            try {
                const publicKey = JSON.parse(publicKeyStr);

                if (!publicKey.e || !publicKey.n) {
                    throw new Error('Ung√ºltiger Public Key');
                }

                // Create certificate
                const data = JSON.stringify({ name: name, publicKey: publicKey });
                const hash = sha256Simple(data);
                const signature = modPow(hash, caKeys.privateKey.d, caKeys.privateKey.n);

                const certificate = {
                    name: name,
                    publicKey: publicKey,
                    signature: signature
                };

                document.getElementById('issuedCertResult').innerHTML = `
                    <div class="result-box">
                        <h5>‚úÖ Zertifikat ausgestellt</h5>
                        <p><strong>F√ºr:</strong> ${name}</p>
                        <p><strong>Zertifikat (zum Kopieren):</strong></p>
                        <textarea readonly style="width: 100%; min-height: 100px; font-family: monospace; font-size: 0.85rem;">${JSON.stringify(certificate, null, 2)}</textarea>
                    </div>
                    <div class="highlight mt-2">
                        <p><strong>Hinweis:</strong> Dieses Zertifikat kann nun an ${name} weitergegeben werden.</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('issuedCertResult').innerHTML = `
                    <div class="error-box">
                        <strong>‚ùå Fehler:</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ==================== Step 4: Send ====================
        function encryptMessage() {
            const recipientIndex = document.getElementById('recipientSelect').value;
            const message = document.getElementById('messageToSend').value.trim();

            if (!recipientIndex) {
                alert('Bitte Empf√§nger w√§hlen!');
                return;
            }

            if (!message) {
                alert('Bitte Nachricht eingeben!');
                return;
            }

            const recipient = contacts[recipientIndex];
            const messageNumbers = stringToNumbers(message);

            // Encrypt each character
            const encrypted = messageNumbers.map(m => 
                modPow(m, recipient.publicKey.e, recipient.publicKey.n)
            );

            document.getElementById('sendResult').innerHTML = `
                <div class="result-box">
                    <h5>üîí Nachricht verschl√ºsselt</h5>
                    <p><strong>Empf√§nger:</strong> ${recipient.name}</p>
                    <p><strong>Verschl√ºsselte Nachricht:</strong></p>
                    <textarea readonly style="width: 100%; min-height: 100px; font-family: monospace; font-size: 0.85rem;">${JSON.stringify({ encrypted: encrypted, recipient: recipient.name }, null, 2)}</textarea>
                </div>
            `;
        }

        function signMessage() {
            const message = document.getElementById('messageToSend').value.trim();

            if (!message) {
                alert('Bitte Nachricht eingeben!');
                return;
            }

            if (!myKeys) {
                alert('Bitte zuerst eigene Schl√ºssel generieren!');
                return;
            }

            const hash = sha256Simple(message);
            const signature = modPow(hash, myKeys.privateKey.d, myKeys.privateKey.n);

            document.getElementById('sendResult').innerHTML = `
                <div class="result-box">
                    <h5>‚úçÔ∏è Nachricht signiert</h5>
                    <p><strong>Absender:</strong> ${myKeys.name}</p>
                    <p><strong>Signierte Nachricht:</strong></p>
                    <textarea readonly style="width: 100%; min-height: 100px; font-family: monospace; font-size: 0.85rem;">${JSON.stringify({ message: message, signature: signature, sender: myKeys.name }, null, 2)}</textarea>
                </div>
            `;
        }

        function encryptAndSign() {
            const recipientIndex = document.getElementById('recipientSelect').value;
            const message = document.getElementById('messageToSend').value.trim();

            if (!recipientIndex) {
                alert('Bitte Empf√§nger w√§hlen!');
                return;
            }

            if (!message) {
                alert('Bitte Nachricht eingeben!');
                return;
            }

            if (!myKeys) {
                alert('Bitte zuerst eigene Schl√ºssel generieren!');
                return;
            }

            const recipient = contacts[recipientIndex];
            const messageNumbers = stringToNumbers(message);

            // Encrypt
            const encrypted = messageNumbers.map(m => 
                modPow(m, recipient.publicKey.e, recipient.publicKey.n)
            );

            // Sign
            const hash = sha256Simple(message);
            const signature = modPow(hash, myKeys.privateKey.d, myKeys.privateKey.n);

            const secureMessage = {
                encrypted: encrypted,
                signature: signature,
                sender: myKeys.name,
                recipient: recipient.name
            };

            document.getElementById('sendResult').innerHTML = `
                <div class="result-box">
                    <h5>üîê Nachricht verschl√ºsselt & signiert</h5>
                    <p><strong>Von:</strong> ${myKeys.name}</p>
                    <p><strong>An:</strong> ${recipient.name}</p>
                    <p><strong>Sichere Nachricht:</strong></p>
                    <textarea readonly style="width: 100%; min-height: 150px; font-family: monospace; font-size: 0.85rem;">${JSON.stringify(secureMessage, null, 2)}</textarea>
                </div>
                <div class="highlight-box mt-2">
                    <h5>‚úÖ Sicherheit:</h5>
                    <p>‚Ä¢ Vertraulichkeit: Nur ${recipient.name} kann die Nachricht lesen</p>
                    <p>‚Ä¢ Authentizit√§t: ${recipient.name} kann verifizieren, dass die Nachricht von dir stammt</p>
                </div>
            `;
        }

        // ==================== Step 5: Receive ====================
        function decryptMessage() {
            const receivedStr = document.getElementById('receivedMessage').value.trim();

            if (!receivedStr) {
                alert('Bitte empfangene Nachricht einf√ºgen!');
                return;
            }

            if (!myKeys) {
                alert('Bitte zuerst eigene Schl√ºssel generieren!');
                return;
            }

            try {
                const received = JSON.parse(receivedStr);

                if (!received.encrypted) {
                    throw new Error('Keine verschl√ºsselte Nachricht gefunden');
                }

                // Decrypt
                const decrypted = received.encrypted.map(c => 
                    modPow(c, myKeys.privateKey.d, myKeys.privateKey.n)
                );

                const message = numbersToString(decrypted);

                document.getElementById('receiveResult').innerHTML = `
                    <div class="result-box">
                        <h5>üîì Nachricht entschl√ºsselt</h5>
                        <p><strong>Entschl√ºsselte Nachricht:</strong></p>
                        <p style="background: white; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">${message}</p>
                    </div>
                `;
            } catch (error) {
                document.getElementById('receiveResult').innerHTML = `
                    <div class="error-box">
                        <strong>‚ùå Fehler:</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function verifySignature() {
            const receivedStr = document.getElementById('receivedMessage').value.trim();

            if (!receivedStr) {
                alert('Bitte empfangene Nachricht einf√ºgen!');
                return;
            }

            try {
                const received = JSON.parse(receivedStr);

                if (!received.signature || !received.sender) {
                    throw new Error('Keine Signatur oder Absender gefunden');
                }

                // Find sender in contacts
                const sender = contacts.find(c => c.name === received.sender);
                if (!sender) {
                    throw new Error('Absender nicht in Kontakten gefunden');
                }

                // Get original message
                let message;
                if (received.message) {
                    message = received.message;
                } else if (received.encrypted && myKeys) {
                    const decrypted = received.encrypted.map(c => 
                        modPow(c, myKeys.privateKey.d, myKeys.privateKey.n)
                    );
                    message = numbersToString(decrypted);
                } else {
                    throw new Error('Nachricht kann nicht verifiziert werden');
                }

                // Verify signature
                const hash = sha256Simple(message);
                const decryptedHash = modPow(received.signature, sender.publicKey.e, sender.publicKey.n);

                if (hash === decryptedHash) {
                    document.getElementById('receiveResult').innerHTML = `
                        <div class="success-box">
                            <strong>‚úÖ Signatur g√ºltig!</strong>
                            <p>Die Nachricht stammt tats√§chlich von ${received.sender}.</p>
                            <p>Die Nachricht wurde nicht ver√§ndert.</p>
                        </div>
                    `;
                } else {
                    throw new Error('Signatur ung√ºltig!');
                }
            } catch (error) {
                document.getElementById('receiveResult').innerHTML = `
                    <div class="error-box">
                        <strong>‚ùå Fehler:</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function decryptAndVerify() {
            const receivedStr = document.getElementById('receivedMessage').value.trim();

            if (!receivedStr) {
                alert('Bitte empfangene Nachricht einf√ºgen!');
                return;
            }

            if (!myKeys) {
                alert('Bitte zuerst eigene Schl√ºssel generieren!');
                return;
            }

            try {
                const received = JSON.parse(receivedStr);

                if (!received.encrypted || !received.signature || !received.sender) {
                    throw new Error('Unvollst√§ndige Nachricht');
                }

                // Find sender
                const sender = contacts.find(c => c.name === received.sender);
                if (!sender) {
                    throw new Error('Absender nicht in Kontakten gefunden');
                }

                // Decrypt
                const decrypted = received.encrypted.map(c => 
                    modPow(c, myKeys.privateKey.d, myKeys.privateKey.n)
                );
                const message = numbersToString(decrypted);

                // Verify signature
                const hash = sha256Simple(message);
                const decryptedHash = modPow(received.signature, sender.publicKey.e, sender.publicKey.n);

                if (hash === decryptedHash) {
                    document.getElementById('receiveResult').innerHTML = `
                        <div class="result-box">
                            <h5>üîì Nachricht entschl√ºsselt</h5>
                            <p><strong>Von:</strong> ${received.sender}</p>
                            <p><strong>Nachricht:</strong></p>
                            <p style="background: white; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">${message}</p>
                        </div>
                        <div class="success-box mt-2">
                            <strong>‚úÖ Signatur g√ºltig!</strong>
                            <p>Die Nachricht stammt tats√§chlich von ${received.sender} und wurde nicht ver√§ndert.</p>
                        </div>
                    `;
                } else {
                    document.getElementById('receiveResult').innerHTML = `
                        <div class="result-box">
                            <h5>üîì Nachricht entschl√ºsselt</h5>
                            <p><strong>Nachricht:</strong></p>
                            <p style="background: white; padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">${message}</p>
                        </div>
                        <div class="error-box mt-2">
                            <strong>‚ö†Ô∏è Warnung: Signatur ung√ºltig!</strong>
                            <p>Die Nachricht k√∂nnte gef√§lscht oder ver√§ndert worden sein.</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('receiveResult').innerHTML = `
                    <div class="error-box">
                        <strong>‚ùå Fehler:</strong>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ==================== Initialize ====================
        window.addEventListener('load', () => {
            // Initialize progress bar
            document.getElementById('progressBar').style.width = '0%';
        });
    </script>
</body>
</html>
